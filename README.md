# 🎯 YOLO 实时目标检测 Web 应用

基于 YOLOv8 和 Streamlit 的实时目标检测应用，支持通过浏览器摄像头进行实时检测，并展示统计图表和汇总报告。可部署到 Streamlit Cloud。

[![Streamlit App](https://static.streamlit.io/badges/streamlit_badge_black_white.svg)](https://streamlit.io/)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![YOLOv8](https://img.shields.io/badge/YOLO-v8-green.svg)](https://github.com/ultralytics/ultralytics)

## ✨ 功能特点

- 🎥 **实时摄像头检测** - 使用 WebRTC 技术，直接在浏览器中捕获摄像头视频流
- 🤖 **YOLOv8 目标检测** - 使用最新的 YOLOv8 模型进行高效目标检测
- 📊 **实时统计图表** - 动态展示当前帧检测结果
- 📈 **检测结果汇总** - 停止后显示完整统计报告，包含饼图、柱状图等
- ☁️ **云端部署支持** - 完全兼容 Streamlit Cloud 部署
- 🔧 **可调参数** - 支持实时调整置信度阈值

## 📸 应用界面

### 实时检测模式
```
┌─────────────────────────────────────────────────────────────┐
│  🎯 YOLO 实时目标检测                                        │
├─────────────────────────────────┬───────────────────────────┤
│                                 │  📊 检测统计               │
│     📹 实时检测                  │  🔴 实时检测中             │
│     ┌─────────────────────┐    │  当前帧检测到 3 个对象      │
│     │                     │    │  ┌─────────────────────┐  │
│     │   [摄像头画面]       │    │  │ 类别    │ 置信度    │  │
│     │   带检测框标注       │    │  │ person │ 95.2%    │  │
│     │                     │    │  │ laptop │ 87.3%    │  │
│     └─────────────────────┘    │  └─────────────────────┘  │
│         [START] [STOP]         │                           │
└─────────────────────────────────┴───────────────────────────┘
```

### 汇总统计模式（停止后）
```
┌─────────────────────────────────────────────────────────────┐
│  📈 检测汇总                                                 │
├──────────────┬──────────────┬──────────────┬───────────────┤
│ 📷 处理帧数   │ 🎯 总检测次数 │ 📦 类别数    │ ⏱️ 检测时长   │
│     150      │     420      │      5       │    30.5秒    │
├──────────────┴──────────────┴──────────────┴───────────────┤
│  📊 各类别检测次数 [柱状图]    📈 各类别平均置信度 [柱状图]    │
├─────────────────────────────────────────────────────────────┤
│  📋 类别详细统计                                             │
│  ┌────────┬────────┬────────┬──────────┬────────┬────────┐ │
│  │ 类别   │ 检测次数│ 占比   │ 平均置信度│ 最高   │ 最低   │ │
│  │ person │  200   │ 47.6% │  92.5%   │ 98.1% │ 85.2% │ │
│  │ laptop │  120   │ 28.6% │  88.3%   │ 95.0% │ 78.5% │ │
│  └────────┴────────┴────────┴──────────┴────────┴────────┘ │
├─────────────────────────────────────────────────────────────┤
│  🥧 类别占比分布 [交互式饼图]                                 │
└─────────────────────────────────────────────────────────────┘
```

## 🚀 快速开始

### 环境要求

- Python 3.8+
- 支持 WebRTC 的浏览器（Chrome、Edge、Firefox）
- 摄像头设备

### 安装依赖

```bash
# 克隆项目
git clone https://github.com/your-username/yolo-streamlit-cloud.git
cd yolo-streamlit-cloud

# 安装依赖
pip install -r requirements.txt
```

### 本地运行

```bash
streamlit run app.py
```

然后在浏览器中打开 http://localhost:8501

## 📁 项目结构

```
yolo_streamlit_cloud/
├── app.py                 # 主应用文件
├── turn.py                # TURN 服务器配置
├── requirements.txt       # 依赖列表
├── yolov8n.pt            # YOLOv8 模型文件
├── README.md             # 项目说明
└── WEBRTC_DEPLOYMENT_GUIDE.md  # WebRTC 部署指南
```

## 🏗️ 技术实现

### 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户浏览器                                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐ │
│  │  摄像头输入  │ →  │  WebRTC 流  │ →  │  显示检测结果画面   │ │
│  └─────────────┘    └─────────────┘    └─────────────────────┘ │
└──────────────────────────┬──────────────────────────────────────┘
                           │ 视频帧
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Streamlit 服务端                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐ │
│  │   turn.py   │    │   app.py    │    │   统计图表渲染      │ │
│  │  ICE配置    │ →  │ YOLO 检测   │ →  │  session_state     │ │
│  └─────────────┘    └─────────────┘    └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 模块说明

#### 1. `turn.py` - 网络连接配置

| 功能 | 说明 |
|------|------|
| **主要作用** | 配置 WebRTC 的 ICE 服务器，确保浏览器与服务器能建立视频流连接 |
| **TURN 服务器** | 使用 Twilio API 获取，用于穿透防火墙和 NAT |
| **STUN 服务器** | 回退方案，使用 Google 免费服务器 |
| **缓存机制** | `@st.cache_data` 避免重复调用 API |

#### 2. `app.py` - 主应用

**模型加载**
```python
@st.cache_resource
def load_yolo_model(model_path):
    return YOLO(model_path)
```
- `@st.cache_resource`: 模型只加载一次，跨会话共享

**线程间数据共享**
```python
lock = threading.Lock()
result_container = {"objects": [], "frame_count": 0}
```
- WebRTC 回调在独立线程运行，需通过全局容器 + 锁实现线程安全共享

**视频帧处理流程**
```
浏览器摄像头 → VideoFrame → numpy数组 → YOLO检测 → 绘制标注 → VideoFrame → 浏览器显示
                                           ↓
                               result_container (共享结果)
```

**状态持久化**
```python
st.session_state.detection_history = {
    "current_objects": [],       # 当前帧
    "all_detections": [],        # 累计所有检测
    "frame_count": 0,            # 帧数
    "start_time": None,          # 开始时间
    "end_time": None,            # 结束时间
    "class_counts": Counter(),   # 类别统计
}
```
- 解决 Streamlit 脚本重新运行时数据丢失的问题

### 核心数据流

```
┌──────────────────────────────────────────────────────────────────────┐
│                          完整数据流                                   │
├──────────────────────────────────────────────────────────────────────┤
│  ┌─────────┐     ┌─────────────┐     ┌─────────────────────────┐   │
│  │ 摄像头  │ ──→ │  WebRTC     │ ──→ │  video_frame_callback   │   │
│  └─────────┘     │  (浏览器)   │     │  (服务端回调线程)        │   │
│                  └─────────────┘     └───────────┬─────────────┘   │
│                                                  │                  │
│                                      ┌───────────▼───────────┐     │
│                                      │     YOLO 检测         │     │
│                                      │  model(image, conf)   │     │
│                                      └───────────┬───────────┘     │
│                        ┌─────────────────────────┼──────────────┐  │
│                        ▼                         ▼              │  │
│           ┌────────────────────┐    ┌────────────────────────┐ │  │
│           │  result_container  │    │  annotated_frame       │ │  │
│           │  (线程共享)         │    │  (带标注的视频帧)       │ │  │
│           └─────────┬──────────┘    └───────────┬────────────┘ │  │
│                     │ (lock)                    │               │  │
│                     ▼                           ▼               │  │
│           ┌────────────────────┐    ┌────────────────────────┐ │  │
│           │  main() 主循环     │    │  返回浏览器显示         │ │  │
│           │  while playing:    │    └────────────────────────┘ │  │
│           └─────────┬──────────┘                               │  │
│                     ▼                                           │  │
│           ┌────────────────────┐                               │  │
│           │  session_state     │←── 持久化保存                  │  │
│           │  detection_history │                               │  │
│           └─────────┬──────────┘                               │  │
│          ┌──────────┴──────────┐                               │  │
│          ▼                     ▼                               │  │
│  ┌──────────────┐     ┌──────────────────┐                    │  │
│  │ 实时统计渲染  │     │ 汇总统计渲染      │                    │  │
│  │ (检测中)     │     │ (停止后)         │                    │  │
│  └──────────────┘     └──────────────────┘                    │  │
└────────────────────────────────────────────────────────────────────┘
```

### 关键技术要点

| 问题 | 解决方案 |
|------|----------|
| **NAT 穿透** | 配置 TURN 服务器 (Twilio) |
| **回调线程与主线程隔离** | 全局 `lock` + `result_container` |
| **Streamlit 脚本重运行丢失数据** | `st.session_state` |
| **模型重复加载** | `@st.cache_resource` |
| **OpenCV 内存泄漏** | 使用 `PIL.Image` 替代 `cv2.resize` |
| **实时更新 UI** | `while` 循环 + `st.empty()` 占位符 |

## 📦 依赖说明

| 依赖包 | 版本 | 说明 |
|--------|------|------|
| streamlit | >=1.28.0 | Web 应用框架 |
| streamlit-webrtc | >=0.45.0 | WebRTC 组件 |
| ultralytics | >=8.0.0 | YOLOv8 模型 |
| opencv-python-headless | >=4.8.0 | 图像处理 |
| av | >=10.0.0 | 视频帧处理 |
| twilio | >=8.1.0 | TURN 服务器（可选） |
| pandas | >=2.0.0 | 数据处理 |
| Pillow | >=10.0.0 | 图像处理 |
| plotly | >=5.18.0 | 交互式图表 |

## 📊 统计功能说明

### 实时模式
检测过程中显示：
- 当前帧检测到的对象数量
- 当前帧各对象的类别和置信度

### 汇总模式
停止检测后显示完整统计：

| 统计项 | 说明 |
|--------|------|
| 📷 处理帧数 | 总共处理了多少帧视频 |
| 🎯 总检测次数 | 累计检测到的对象总数 |
| 📦 类别数 | 检测到的不同类别数量 |
| ⏱️ 检测时长 | 从开始到结束的总时间 |
| 📊 检测次数柱状图 | 各类别被检测到的次数 |
| 📈 置信度柱状图 | 各类别的平均置信度 |
| 📋 详细统计表 | 包含占比、最高/最低置信度 |
| 🥧 占比饼图 | 交互式类别占比分布图 |

## ☁️ Streamlit Cloud 部署

### 步骤 1：推送代码到 GitHub

```bash
git add .
git commit -m "Initial commit"
git push origin main
```

### 步骤 2：在 Streamlit Cloud 部署

1. 访问 [Streamlit Cloud](https://share.streamlit.io/)
2. 连接你的 GitHub 仓库
3. 选择 `app.py` 作为主文件
4. 点击 Deploy

### 步骤 3：配置 TURN 服务器（推荐）

在 Streamlit Cloud 的 Settings → Secrets 中添加：

```toml
TWILIO_ACCOUNT_SID = "your_account_sid"
TWILIO_AUTH_TOKEN = "your_auth_token"
```

#### 获取 Twilio 凭证

1. 注册 [Twilio](https://www.twilio.com/) 账号
2. 进入控制台获取 Account SID 和 Auth Token
3. Twilio 提供免费试用额度

> ⚠️ **注意**：如果不配置 TURN 服务器，应用会使用免费的 Google STUN 服务器。在某些网络环境下（如公司防火墙后）可能无法正常工作。

## 🔧 配置说明

### 置信度阈值

通过侧边栏滑块调整，范围 0.1 - 1.0：
- **低阈值 (0.1-0.3)**：检测更多对象，但可能有误检
- **中阈值 (0.4-0.6)**：平衡检测率和准确率
- **高阈值 (0.7-1.0)**：只显示高置信度检测结果

### 模型选择

当前使用 YOLOv8n（nano）模型：
- 速度最快，适合实时检测
- 支持 80 种 COCO 数据集类别

### 清除历史

点击侧边栏的 🗑️ 清除检测历史 按钮可以重置所有统计数据。

## 🐛 常见问题

### Q1: 点击 START 后摄像头无法启动？

**A:** 
- 确保浏览器已获得摄像头权限
- 使用 HTTPS 或 localhost 访问
- 尝试使用 Chrome 或 Edge 浏览器

### Q2: 部署后 WebRTC 连接失败？

**A:**
- 配置 Twilio TURN 服务器
- 检查网络是否有防火墙限制
- 查看 Streamlit Cloud 日志

### Q3: 检测速度较慢？

**A:**
- 这是正常现象，YOLOv8n 在 CPU 上运行
- 可以降低视频分辨率
- 云端部署可能比本地慢

### Q4: 统计图表不更新？

**A:**
- 确保摄像头正在运行（显示绿色状态）
- 将物体放在摄像头前以触发检测
- 统计会每 0.5 秒自动更新

### Q5: 停止后看不到汇总统计？

**A:**
- 确保在检测过程中有物体被检测到
- 如果没有检测到任何物体，汇总统计将为空
- 可以降低置信度阈值来增加检测灵敏度

## 📚 技术参考

- [streamlit-webrtc](https://github.com/whitphx/streamlit-webrtc) - WebRTC Streamlit 组件
- [YOLOv8](https://github.com/ultralytics/ultralytics) - 目标检测模型
- [Streamlit](https://streamlit.io/) - Web 应用框架
- [Twilio TURN](https://www.twilio.com/docs/stun-turn) - TURN 服务器文档
- [Plotly](https://plotly.com/python/) - 交互式图表库

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

Made with ❤️ using Streamlit and YOLOv8
